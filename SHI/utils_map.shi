#!/bin/bash

# NB: This works but has limitations, in particular it is possible to get errors
# if a Map name is similar (pattern match wise) to a Key name.
# Watch for updates. Contributions welcome.

. utils_core.shi
if ! alreadyIncluded UTILS_MAP; then

### START CONTENT

### Simulate Multi Dimentional HASH/MAP/ASSOCIATIVE ARRAY.
### Todo: fully test and perhaps mv 'value' as last arg...

# e.g. 
# - name is name of multi-d map.
# - value is a value to be put into the map.
# - 1 2 3 - are keys (3d in this case)
# - AA BB - are keys (2d in this case)
#
# setMapValue name value 1 2 3 ... N etc.
# getMapValue name 1 2 3 ... N

# 'local' variable storing multi-d maps.
declare -A _D

_MANGLE_=_
_SEP=','

_mangle()	# local usage - convert $1 to its internally used format.
{
	echo "$_MANGLE_""$1""$_MANGLE_"
}

_createRealKey()
{
	checkNotEmptyString "error in key(s) (at least one value needed)" $1

	local FULL=
	for i in $*; do
		PART=$(_mangle $i)
		FULL="$FULL$_SEP$PART"
	done
	echo $FULL
}

_allMapKeys()
{
	echo ${!_D[@]}	# All mangled.
}


_allMapKeyValues()
{
	for mangled_key in $(_allMapKeys); do
		echo $mangled_key: ${_D[$mangled_key]}
	done
}

## === 'exported' functions - do not use the above directly, they may change. ====

setMapValue()
{
	local MAPNAME=$1; chkarg MAPNAME; 	# not mangled.
	local VAL=$2; chkarg VAL; 			# never mangled.
	
	shift 2
	# will mangle MAPNAME & $*
	_D[$(_createRealKey $MAPNAME $*)]=$VAL
}

getMapValue()
{
	local MAPNAME=$1; chkarg MAPNAME;	# not mangled.

	shift
	echo "${_D[$(_createRealKey $MAPNAME $*)]}"
}

mapKeys() 
# list all map keys for $1 (in mangled internal format)
{
	local MAPNAME=$1; chkarg MAPNAME;

	local MANGLED_MAPNAME=$(_mangle $MAPNAME)
	for mangled_key in $(_allMapKeys); do
		if [[ "$mangled_key" =~ $MANGLED_MAPNAME ]]; then 
			echo $mangled_key
		fi
	done
}

mapKeyValues() 
# list all map values for $1 (keys shown in mangled internal format)
{
	MAPNAME=$1; chkarg MAPNAME;

	for mangled_key in $(mapKeys $MAPNAME); do
		echo "$mangled_key: ${_D[$mangled_key]}"
	done
}

# END CONTENT
fi
